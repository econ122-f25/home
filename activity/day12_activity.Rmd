---
title: "Logistic Regression In-Class Activity: Titanic Survival Analysis"
author: "Econ 122"
date: "`r Sys.Date()`"
output: github_document
---

```{r setup, include=FALSE}
library(dplyr)
library(ggplot2)
library(broom)
library(purrr)
library(tidyr)
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

# Logistic Regression: Predicting Titanic Survival

**Time:** 40 minutes  
**Objective:** Use logistic regression to predict passenger survival on the Titanic and understand the factors that influenced survival rates.

## Background

On April 15, 1912, the RMS Titanic sank after colliding with an iceberg. Of the estimated 2,224 passengers and crew aboard, more than 1,500 died. Your task is to analyze what factors made some passengers more likely to survive this tragedy.

This dataset contains information about individual passengers, including their ticket class, sex, age, and whether they survived. You'll use logistic regression to identify the key predictors of survival.

## Dataset Introduction

```{r load-data}
# Load the Titanic dataset from base R and convert to a more usable format
titanic_raw <- as.data.frame(Titanic)

# Create individual passenger records from the frequency table
titanic_data <- titanic_raw[rep(row.names(titanic_raw), titanic_raw$Freq), 1:4]
rownames(titanic_data) <- NULL

# Clean up the data
titanic_data <- titanic_data %>%
  mutate(
    survived = ifelse(Survived == "Yes", 1, 0),
    survived_factor = factor(Survived, levels = c("No", "Yes")),
    pclass = case_when(
      Class == "1st" ~ 1,
      Class == "2nd" ~ 2, 
      Class == "3rd" ~ 3,
      Class == "Crew" ~ 4
    ),
    pclass_factor = factor(Class, levels = c("3rd", "2nd", "1st", "Crew")),
    sex = Sex,
    age_group = Age
  ) %>%
  select(survived, survived_factor, pclass, pclass_factor, sex, age_group)

# Display first few rows
head(titanic_data, 10)
```

```{r data-overview}
# Quick overview of the dataset
cat("Dataset dimensions:", dim(titanic_data), "\n")
cat("Total passengers:", nrow(titanic_data), "\n")
```

## Part 1: Data Exploration (8 minutes)

**Task 1.1:** Examine survival rates and create summary statistics.

```{r task-1-1}
# YOUR CODE HERE: 
# - Calculate overall survival rate
# - Show survival rates by sex, passenger class, and age group

```

**Task 1.2:** Create visualizations to explore the relationship between predictors and survival.

```{r task-1-2}
# YOUR CODE HERE:
# - Create a bar chart showing survival rates by sex
# - Create a bar chart showing survival rates by passenger class
# - Create a bar chart showing survival rates by age group
# - What patterns do you notice about who was more likely to survive?

```

**Discussion Question 1:** 
Based on your exploration, what factors appear most strongly related to survival? 
Why might these patterns have occurred historically?

*Your answer:*

## Part 2: Building Logistic Regression Models (12 minutes)

**Task 2.1:** Fit logistic regression models to predict survival:

- Model 1: Age group only
- Model 2: Age group and passenger class
- Model 3: All variables (sex, class, age group)

```{r task-2-1}
# YOUR CODE HERE:
# Fit the three models using glm() with family = binomial
# Use 'survived' as the outcome variable (0/1)

model_age <- 
model_age_class <- 
model_full <- 

```

**Task 2.2:** Extract and interpret the coefficients.

```{r task-2-2}
# YOUR CODE HERE:
# Use tidy() to get clean coefficient summaries for each model
# Calculate odds ratios using exp(estimate)
# Focus on the full model for detailed interpretation

```

**Discussion Question 2:** 

- Interpret the odds ratio for sex (Male vs Female) in practical terms.
- How do the different passenger classes compare in terms of survival odds?
- Which variables are statistically significant in the full model?

*Your answers:*

## Part 3: Model Predictions and Performance (12 minutes)

**Task 3.1:** Generate predictions and add them to your dataset.

```{r task-3-1}
# YOUR CODE HERE:
# Use predict() with type="response" to get survival probabilities
# Add predictions from your best models to the dataset

titanic_data$prob_age <- 
titanic_data$prob_age_class <- 
titanic_data$prob_full <- 

```

**Task 3.2:** Convert probabilities to classifications and evaluate performance.

```{r task-3-2}
# YOUR CODE HERE:
# Create predicted classifications using a 0.5 threshold
# Generate confusion matrices for each model
# Calculate accuracy, precision, recall, and specificity

```

**Task 3.3:** Identify which passengers your model struggles to classify correctly.

```{r task-3-3}
# YOUR CODE HERE:
# Find passengers where your best model's predictions were wrong
# Look at their characteristics (sex, class, age)
# Create a summary of misclassified passengers

```

**Task 3.4:** Create historical passenger profiles.

```{r task-3-4}
# YOUR CODE HERE:
# Use your model to predict survival probability for these passenger types:
# 1. First-class adult female
# 2. Third-class adult male  
# 3. Second-class child
# 4. Crew member (any age/sex)

new_passengers <- data.frame(
  sex = c("Female", "Male", "Male", "Male"),
  pclass = c(1, 3, 2, 4),
  age_group = c("Adult", "Adult", "Child", "Adult")
)

# Predict survival probabilities

```

**Discussion Question 3:** 

- Which model performs best? Why?
- What types of passengers does your model misclassify most often?
- Can you think of historical reasons why these misclassifications might occur?
- Looking at your historical passenger profiles, what do the survival probabilities tell us about social dynamics on the Titanic?

*Your answers:*

## Part 4: ROC Analysis (8 minutes)

**Task 4.1:** Create ROC curves and calculate AUC.

```{r task-4-1}
# YOUR CODE HERE:
# Use the helper function below to create ROC curves and calculate AUC

# Helper function to calculate ROC curve data (provided)
calculate_roc <- function(probabilities, actual_outcomes) {
  # Create a sequence of thresholds from 0 to 1
  thresholds <- seq(0, 1, by = 0.01)
  
  # Calculate TPR and FPR for each threshold
  roc_data <- map_dfr(thresholds, function(thresh) {
    predictions <- ifelse(probabilities > thresh, 1, 0)
    
    tp <- sum(predictions == 1 & actual_outcomes == 1)
    fp <- sum(predictions == 1 & actual_outcomes == 0)
    tn <- sum(predictions == 0 & actual_outcomes == 0)
    fn <- sum(predictions == 0 & actual_outcomes == 1)
    
    tpr <- tp / (tp + fn)  # True Positive Rate (Sensitivity)
    fpr <- fp / (fp + tn)  # False Positive Rate (1 - Specificity)
    
    data.frame(threshold = thresh, tpr = tpr, fpr = fpr)
  })
  
  # Calculate AUC using trapezoidal rule
  roc_data <- roc_data[order(roc_data$fpr), ]
  auc <- sum(diff(roc_data$fpr) * (roc_data$tpr[-1] + roc_data$tpr[-length(roc_data$tpr)])) / 2
  
  return(list(roc_data = roc_data, auc = auc))
}

# Hints for implementation:
# 1. Use calculate_roc() function for each of your three model probabilities
# 2. Combine the ROC data using bind_rows() and add model labels
# 3. Create a ggplot with geom_line() to plot TPR vs FPR
# 4. Add a diagonal reference line using geom_abline(slope=1, intercept=0)
# 5. Include AUC values in your plot legend or print them separately

```

**Discussion Question 4:** 
Looking at your ROC curves:

1. **Model Performance:** Which model has the highest AUC? What does this tell you about its ability to distinguish survivors from non-survivors?

2. **ROC Interpretation:** How does your best model's ROC curve compare to the diagonal line (random classifier)? What does the area under the curve represent?

3. **Performance Trade-offs:** Looking at your precision, recall, and F1 scores, how well does your model balance between correctly identifying survivors vs. avoiding false alarms?

4. **Historical Context:** If this model were used to prioritize lifeboat access, what would be the human cost of false positives vs. false negatives?

*Your analysis:*

## Part 5: Reflection and Extension 

**Task 5.1:** Compare your logistic regression to simple rules.

```{r task-5-1}
# YOUR CODE HERE:
# Create predictions using simple rules like:
# Rule 1: "All females survive, all males don't"
# Rule 2: "First-class passengers survive, others don't"  
# Compare accuracy to your logistic regression model

```

**Discussion Questions:**

1. **Model Insights:** What did logistic regression reveal about Titanic survival that simple rules missed?

3. **Historical Analysis:** How could this type of analysis help historians understand social dynamics in 1912?

4. **Model Improvements:** If you had additional data (like exact location on ship, family relationships, etc.), how might it improve your predictions?

## Bonus Questions

Once you've completed the main activity, try these additional challenges:

**Bonus 1: Historical Context Analysis**
Analyze whether your model supports historical accounts like "women and children first" and the impact of social class. What does the data reveal about society in 1912?

```{r bonus-1, eval=FALSE}
# YOUR CODE HERE:
# Compare survival rates across different groups
# Test statistical significance of differences
```

**Bonus 2: Feature Engineering**
Create a new variable called `family_size` or `title_from_name` and see if it improves your model. How might family relationships have affected survival chances?

```{r bonus-2, eval=FALSE}
# YOUR CODE HERE:
# Create new predictive variables
# Test if they improve model performance
```

**Bonus 3: Interaction Effects**
Test if there are interaction effects between sex and passenger class. Did the "women and children first" rule apply equally across all social classes?

```{r bonus-3, eval=FALSE}
# YOUR CODE HERE:
# Fit a model with interaction terms: sex * pclass
# Interpret the interaction coefficients
```

**Bonus 4: Alternative Thresholds for Historical Decision-Making**

If you were the ship's officer deciding who gets priority for lifeboats based on your model:
- What threshold would you use if lifeboats could save 30% of passengers?
- What threshold would you use if lifeboats could save 50% of passengers?
- How do these decisions change the types of passengers saved?

```{r bonus-4, eval=FALSE}
# YOUR CODE HERE:
# Calculate thresholds that would save specific percentages
# Analyze the demographics of who gets saved under each scenario
```